former_mortality_alternative_prior <- forest_plot(
m8_a,
study_draws_m8_a,
pooled_draw_m8_a,
cut = 5,
"Forest plot of former smokers and mortality",
"v4 mortality prior",
"m8_a.png"
)
former_testing_alternative_prior
current_hospitalisation_alternative_prior
former_hospitalisation_alternative_prior
former_severity_alternative_prior
m8_a_ecdf <- ecdf(exp(post_samples_m8_a$TE))
m8_a_ecdf(1)
former_mortality_alternative_prior
m1_a_ecdf <- ecdf(exp(post_samples_m1_a$TE))
m1_a_ecdf(1)
m2_a_ecdf(1)
m3_a_ecdf(1)
m4_a_ecdf(1)
m5_a_ecdf(1)
m6_a_ecdf(1)
m7_a_ecdf(1)
m8_a_ecdf(1)
current_mortality_alternative_prior <- forest_plot(
m7_a,
study_draws_m7_a,
pooled_draw_m7_a,
cut = 5,
"Forest plot of current smokers and mortality",
"v4 mortality prior",
"m7.png"
)
current_mortality_alternative_prior <- forest_plot(
m7_a,
study_draws_m7_a,
pooled_draw_m7_a,
cut = 5,
"Forest plot of current smokers and mortality",
"v4 mortality prior",
"m7.png"
)
current_mortality_alternative_prior <- forest_plot(
m7_a,
study_draws_m7_a,
pooled_draw_m7_a,
cut = 5,
"Forest plot of current smokers and mortality",
"v4 mortality prior",
"m7_a.png"
)
forest_plot <- function(model, data_study, data_pooled, cut, title, type, filename) {
forest_data <- bind_rows(data_study, data_pooled) %>%
ungroup() %>%
mutate(Author = str_replace_all(Author, "[.]", " ")) %>%
mutate(Author = reorder(Author, b_Intercept),
b_Intercept = exp(b_Intercept))
summary_forest <- group_by(forest_data, Author, review_version) %>%
median_qi(b_Intercept)
graph <- ggplot(aes(b_Intercept, relevel(Author, "Pooled Effect", after = Inf), fill = review_version),
data = forest_data) +
geom_vline(xintercept = exp(fixef(model)[1, 1]),
color = "grey",
size = 1) +
geom_vline(xintercept = exp(fixef(model)[1, 3:4]),
color = "grey",
linetype = 2) +
geom_vline(xintercept = 1,
color = "black",
size = 1) +
geom_density_ridges(
aes(fill = review_version),
rel_min_height = 0.01,
col = NA,
scale = 1,
alpha = 0.8
) +
geom_pointinterval(data = summary_forest, size = 1) +
geom_text(
data = mutate_if(summary_forest, is.numeric, round, 2),
aes(
label = glue("{b_Intercept} [{.lower}, {.upper}]"),
x = cut
),
hjust = "inward",
size = 5
) +
facet_grid(review_version~  ., scales = "free_y", space = "free") +
labs(x = "Relative Risk [95% Credible Interval]",
y = element_blank(),
title = element_blank(),
caption = element_blank()
) +
scale_fill_discrete(name = "Review version", labels = c("Previous version (v5)", "Pooled effect")) +
xlim(0, cut) +
theme_minimal() +
theme(panel.spacing = unit(0.1, "lines"),
strip.text = element_blank(),
axis.text.y = element_text(size = 12))
outputs <- list("plot" = graph, "data" = forest_data, "summary" = summary_forest)
ggsave(filename = filename, plot = graph, device = "png", path = here("reports", "figure"))
return(outputs)
}
extract_TE <- function(dataset) {
tibble(dataset$studlab,
dataset$TE,
dataset$seTE
) %>%
rename(Author = 1, TE = 2, seTE = 3)
}
bayes_test <- function(dataset, defined_prior, iterations) {
brm(
TE | se(seTE) ~ 1 + (1 | Author),
data = dataset,
prior = defined_prior,
iter = iterations,
control = list(adapt_delta = 0.99)
)
}
post_samples <- function(dataset) {
p_samples <- posterior_samples(dataset, c("^b", "^sd")) %>%
rename("TE" = 1,
"tau" = 2)
print(ggplot(aes(x = TE), data = p_samples)+
geom_density(fill = "lightblue",
color = "lightblue",
alpha = 0.7) +
geom_point(y = 0, x = mean(p_samples$TE)) +
labs(x = expression(italic(TE)),
y = element_blank()) +
theme_minimal())
return(p_samples)
}
study_draw <- function(dataset) {
spread_draws(dataset, r_Author[Author,], b_Intercept) %>%
mutate(b_Intercept = r_Author + b_Intercept) %>%
left_join(., study_review_version)
}
pooled_effect_draw <- function(dataset) {
spread_draws(dataset, b_Intercept) %>%
mutate(Author = "Pooled Effect",
review_version = factor("combined_pooled"))
}
forest_plot <- function(model, data_study, data_pooled, cut, title, type, filename) {
forest_data <- bind_rows(data_study, data_pooled) %>%
ungroup() %>%
mutate(Author = str_replace_all(Author, "[.]", " ")) %>%
mutate(Author = reorder(Author, b_Intercept),
b_Intercept = exp(b_Intercept))
summary_forest <- group_by(forest_data, Author, review_version) %>%
median_qi(b_Intercept)
graph <- ggplot(aes(b_Intercept, relevel(Author, "Pooled Effect", after = Inf), fill = review_version),
data = forest_data) +
geom_vline(xintercept = exp(fixef(model)[1, 1]),
color = "grey",
size = 1) +
geom_vline(xintercept = exp(fixef(model)[1, 3:4]),
color = "grey",
linetype = 2) +
geom_vline(xintercept = 1,
color = "black",
size = 1) +
geom_density_ridges(
aes(fill = review_version),
rel_min_height = 0.01,
col = NA,
scale = 1,
alpha = 0.8
) +
geom_pointinterval(data = summary_forest, size = 1) +
geom_text(
data = mutate_if(summary_forest, is.numeric, round, 2),
aes(
label = glue("{b_Intercept} [{.lower}, {.upper}]"),
x = cut
),
hjust = "inward",
size = 5
) +
facet_grid(review_version~  ., scales = "free_y", space = "free") +
labs(x = "Relative Risk [95% Credible Interval]",
y = element_blank(),
title = element_blank(),
caption = element_blank()
) +
scale_fill_discrete(name = "Review version", labels = c("Previous version (v5)", "Pooled effect")) +
xlim(0, cut) +
theme_minimal() +
theme(panel.spacing = unit(0.1, "lines"),
strip.text = element_blank(),
axis.text.y = element_text(size = 12))
outputs <- list("plot" = graph, "data" = forest_data, "summary" = summary_forest)
ggsave(filename = filename, plot = graph, device = "png", path = here("reports", "figure"))
return(outputs)
}
save_plots <- function(plot_name) {
png(here::here('reports', 'figure', paste(plot_name, ".png", sep = "")), width=1024, height=546, res=120)
}
library(brms)
library(ggplot2)
library(tidybayes)
library(readr)
library(dplyr)
library(ggridges)
library(glue)
library(stringr)
library(forcats)
library(here)
library(meta)
former_mortality_minimal_prior <- forest_plot(
m8,
study_draws_m8,
pooled_draw_m8,
cut = 5,
"Forest plot of former smokers and mortality",
"Minimally informative prior",
"m8.png"
)
former_mortality_alternative_prior <- forest_plot(
m8_a,
study_draws_m8_a,
pooled_draw_m8_a,
cut = 5,
"Forest plot of former smokers and mortality",
"v4 mortality prior",
"m8_a.png"
)
current_mortality_minimal_prior <- forest_plot(
m7,
study_draws_m7,
pooled_draw_m7,
cut = 5,
"Forest plot of current smokers and mortality",
"Minimally informative prior",
"m7.png"
)
current_mortality_alternative_prior <- forest_plot(
m7_a,
study_draws_m7_a,
pooled_draw_m7_a,
cut = 5,
"Forest plot of current smokers and mortality",
"v4 mortality prior",
"m7_a.png"
)
forest_plot <- function(model, data_study, data_pooled, cut, title, type, filename) {
forest_data <- bind_rows(data_study, data_pooled) %>%
ungroup() %>%
mutate(Author = str_replace_all(Author, "[.]", " ")) %>%
mutate(Author = reorder(Author, b_Intercept),
b_Intercept = exp(b_Intercept))
summary_forest <- group_by(forest_data, Author, review_version) %>%
median_qi(b_Intercept)
graph <- ggplot(aes(b_Intercept, relevel(Author, "Pooled Effect", after = Inf), fill = review_version),
data = forest_data) +
geom_vline(xintercept = exp(fixef(model)[1, 1]),
color = "grey",
size = 1) +
geom_vline(xintercept = exp(fixef(model)[1, 3:4]),
color = "grey",
linetype = 2) +
geom_vline(xintercept = 1,
color = "black",
size = 1) +
geom_density_ridges(
aes(fill = review_version),
rel_min_height = 0.01,
col = NA,
scale = 1,
alpha = 0.8
) +
geom_pointinterval(data = summary_forest, size = 1) +
geom_text(
data = mutate_if(summary_forest, is.numeric, round, 2),
aes(
label = glue("{b_Intercept} [{.lower}, {.upper}]"),
x = cut
),
hjust = "inward",
size = 5
) +
facet_grid(review_version~  ., scales = "free_y", space = "free") +
labs(x = "Relative Risk [95% Credible Interval]",
y = element_blank(),
title = element_blank(),
caption = element_blank()
) +
scale_fill_discrete(name = "Review version", labels = c("Previous version (v5)", "Current version (v6)", "Pooled effect")) +
xlim(0, cut) +
theme_minimal() +
theme(panel.spacing = unit(0.1, "lines"),
strip.text = element_blank(),
axis.text.y = element_text(size = 12))
outputs <- list("plot" = graph, "data" = forest_data, "summary" = summary_forest)
ggsave(filename = filename, plot = graph, device = "png", path = here("reports", "figure"))
return(outputs)
}
current_mortality_alternative_prior
former_mortality_alternative_prior
post_samples_m1_a
m1_a_ecdf_tau <- ecdf(exp(post_samples_m1_a$tau))
m1_a_ecdf_tau
m1_a_ecdf_tau <- ecdf(post_samples_m1_a$tau)
m1_a_ecdf_tau
plot(m1_a_ecdf_tau)
m1_a_ecdf_tau <- ecdf(exp(post_samples_m1_a$tau))
m1
bayes_testing_current
bayes_testing_current$se.tau2
m1_a_ecdf_tau <- ecdf((post_samples_m1_a$tau)^2)
m1_a_ecdf_tau
plot(m1_a_ecdf_tau)
?ecdf
m1_a
m1_a$data
m1_a$data2
View(m1)
View(m1)
m1
m1$stanvars
m1$ranef
m1$backend
m1$model
m1$criteria
m1$data.name
m1_a_ecdf_tau <- ecdf(post_samples_m1_a$tau)
m1_a_ecdf_tau(1)
m1_a_ecdf_tau
plot(post_samples_m1_a$tau)
post_samples_m1_a
ggplot(data = post_samples_m1_a, aes(y = tau)) +
geom_line()
ggplot(data = post_samples_m1_a, aes(y = tau)) +
geom_point()
str(post_samples_m1_a)
ggplot(data = post_samples_m1_a, aes(x = rowname(), y = tau)) +
geom_point()
m1_a_ecdf_tau <- ecdf(post_samples_m1_a$tau) %>%
mutate(sample = row.names(post_samples_m1_a))
post_samples_m1_a %>%
mutate(sample = row.names(post_samples_m1_a))
ggplot(data = post_samples_m1_a, aes(x = sample, y = tau)) +
geom_point()
test <- post_samples_m1_a %>%
mutate(sample = row.names(post_samples_m1_a))
ggplot(data = test, aes(x = sample, y = tau)) +
geom_point()
ggplot(data = test, aes(y = tau)) +
geom_histogram()
ggplot(data = test, aes(x = tau)) +
geom_histogram()
post_samples_m1_a
ranef(m1)
summary(m1)
m1_a
m1_a_tau_2 <- post_samples_m1_a$tau^2
m1_a_tau_2
ggplot(m1_a_tau_2) +
geom_histogram()
m1_a_tau_2 <- post_samples_m1_a %>%
mutate(tau_2 = tau^2)
ggplot(m1_a_tau_2, aes(x = tau_2)) +
geom_histogram()
geom_histogram()
ggplot(m1_a_tau_2, aes(x = ln(tau_2))) +
geom_histogram()
ggplot(m1_a_tau_2, aes(x = log(tau_2))) +
geom_histogram()
ggplot(m1_a_tau_2, aes(x = tau_2)) +
geom_histogram()
post_samples_m1_a
m1_a
summary(m1_a_tau_2$tau_2)
m1_a
m1_a_tau_2
t.test(m1_a_tau_2$tau_2)
t.test(log(m1_a_tau_2$tau_2))
ggplot(m1_a_tau_2, aes(x = log(tau_2))) +
geom_histogram()
ggplot(m1_a, aes(x = tau)) +
geom_histogram()
ggplot(post_samples_m1_a, aes(x = tau)) +
geom_histogram()
ggplot(post_samples_m1_a, aes(x = log(tau))) +
geom_histogram()
t.test(log(m1_a_tau_2$tau))
a <- t.test(log(m1_a_tau_2$tau))
a$statistic
exp(a$estimate)
m1
m1_a
m2_a
m5_a
m6_a
post_samples_m5
study_draws_m5
pooled_draw_m5_a
current_severity_minimal_prior
current_testing_prior_hh <-
c(prior(normal(-.15, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd))
former_testing_prior_hh <-
c(prior(normal(0.009, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd))
current_hospitalisation_prior_hh <-
c(prior(normal(0.06, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.06 is ln(1.06311)
former_hospitalisation_prior_hh <-
c(prior(normal(0.18, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.18 is ln(1.1997)
current_severity_prior_hh <-
c(prior(normal(0.2, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.2 is ln(1.2214)
former_severity_prior_hh <-
c(prior(normal(0.46, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.46 is ln(1.5775)
current_mortality_prior_hh <-
c(prior(normal(0.34, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.34 is ln(1.41) result from v4
former_mortality_prior_hh <-
c(prior(normal(-0.02, 1), class = Intercept),
prior(cauchy(0.37, 1), class = sd)) #0.0.02 is ln(0.98) result from v4
m1_a_hh <-
bayes_test(testing_bayes_c, current_testing_prior_hh, iterations = 40000)
pp_check(m1_a_hh)
summary(m1_a_hh)
ranef(m1_a_hh)
# Bayesian analysis for current smokers and testing for SARS-CoV-2
post_samples_m1 <- post_samples(m1)
post_samples_m1_a <- post_samples(m1_a)
post_samples_m1_a_hh <- post_samples(m1_a_hh)
study_draws_m1 <- study_draw(m1)
pooled_draw_m1 <- pooled_effect_draw(m1)
pooled_draw_m1 <- pooled_effect_draw(m1)
study_draws_m1_a <- study_draw(m1_a)
pooled_draw_m1_a <- pooled_effect_draw(m1_a)
study_draws_m1_a_hh <- study_draw(m1_a_hh)
pooled_draw_m1_a_hh <- pooled_effect_draw(m1_a_hh)
current_testing_minimal_prior <- forest_plot(
m1,
study_draws_m1,
pooled_draw_m1,
cut = 4,
"Forest plot of current smokers and risk of testing positive",
"Minimally informative prior",
"m1.png"
)
current_testing_alternative_prior <- forest_plot(
m1_a,
study_draws_m1_a,
pooled_draw_m1_a,
cut = 4,
"Forest plot of current smokers and risk of testing positive",
"v5 testing prior",
"m1_a.png"
)
current_testing_alternative_prior_hh <- forest_plot(
m1_a_hh,
study_draws_m1_a_hh,
pooled_draw_m1_a_hh,
cut = 4,
"Forest plot of current smokers and risk of testing positive",
"v5 testing prior",
"m1_a_hh.png"
)
current_testing_minimal_prior
current_testing_alternative_prior
current_testing_alternative_prior_hh
exp(0.08)
exp(0.3)
exp(0.003)
log(0.3)
log(0.08)
m1_a
t.test(m1_a$data$seTE)
t.test(m1_a$data$seTE^2)
m1_a_ecdf
m1_a_ecdf(1)
m1_a_ecdf(0.95)
m1_a_ecdf(1.05)
m1_a_ecdf(1.05) - m1_a_ecdf(0.95)
m2_a_ecdf(1.05)
m2_a_ecdf(1.05)-m2_a_ecdf(0.95)
m2_a_ecdf(0.95)
m2_a_ecdf(1.05)
m2_a_ecdf(1.05)-m2_a_ecdf(0.95)
m2_a_ecdf(1)
m2_a_ecdf(1.01)
m2_a_ecdf(1.0000000001)
m2_a_ecdf(1.001)
m2_a_ecdf(1.01)
current_testing_alternative_prior
m1_a
m2_a
m2_a_ecdf(1.01)
1-m2_a_ecdf(1.01)
m3_a
m4_a
1-m3_a_ecdf(1)
1-m3_a_ecdf(1.01)
1-m1_a_ecdf(1.01)
1-m3_a_ecdf(1.01)
1-m4_a_ecdf(1.01)
m5_a
m6_a
1-m5_a_ecdf(1.01)
1-m6_a_ecdf(1.01)
m7_a
m8_a
1-m7_a_ecdf(1.01)
1-m8_a_ecdf(1.01)
